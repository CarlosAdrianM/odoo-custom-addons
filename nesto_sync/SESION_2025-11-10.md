# Sesi√≥n 2025-11-10: Configuraci√≥n y Testing Bidireccional

**Duraci√≥n**: ~2 horas
**Estado**: C√≥digo funcional en Odoo18, pendiente sincronizar a producci√≥n

## üéØ Objetivos de la Sesi√≥n

1. Configurar credenciales Google Cloud para Pub/Sub
2. Probar sincronizaci√≥n bidireccional desde UI
3. Troubleshoot y arreglar bugs encontrados

## ‚úÖ Logros Completados

### 1. Configuraci√≥n de Credenciales (Odoo18)

**Archivo creado**: `/opt/odoo16/secrets/google-cloud-credentials.json`
- Project ID: `nestomaps-1547636206945`
- Service Account: `nesto-130@nestomaps-1547636206945.iam.gserviceaccount.com`

**Permisos configurados**:
```bash
sudo mkdir -p /opt/odoo16/secrets
sudo chmod 700 /opt/odoo16/secrets
sudo chmod 600 /opt/odoo16/secrets/google-cloud-credentials.json
sudo chown odoo:odoo /opt/odoo16/secrets/google-cloud-credentials.json
```

**Variable de entorno en systemd**:
```ini
Environment="GOOGLE_APPLICATION_CREDENTIALS=/opt/odoo16/secrets/google-cloud-credentials.json"
```

**System Parameters configurados**:
- `nesto_sync.google_project_id` = `nestomaps-1547636206945`
- `nesto_sync.pubsub_topic` = `sincronizacion-tablas`

### 2. Bug Fix: JSON Serialization

**Problema**: Error `Object of type res.country.state is not JSON serializable`

**Causa**: Los campos Many2one (state_id, country_id) devuelven objetos Odoo completos, no IDs

**Soluci√≥n**: Nuevo m√©todo en `odoo_publisher.py:221-259`

```python
def _serialize_odoo_value(self, value):
    """
    Serializa valores de Odoo para JSON
    
    Convierte objetos Odoo (Many2one, Many2many, recordset) a valores serializables
    """
    if value is None or isinstance(value, (bool, int, float, str)):
        return value
    
    if hasattr(value, '_name') and hasattr(value, 'id'):
        if len(value) == 1:
            return value.id  # Many2one
        elif len(value) > 1:
            return value.ids  # Many2many
        else:
            return None  # Recordset vac√≠o
    
    if isinstance(value, (list, tuple)):
        return [self._serialize_odoo_value(v) for v in value]
    
    if isinstance(value, dict):
        return {k: self._serialize_odoo_value(v) for k, v in value.items()}
    
    return str(value)
```

**Modificaci√≥n en l√≠nea 103-104**:
```python
# ANTES
value = getattr(record, odoo_field, None)

# DESPU√âS
value = getattr(record, odoo_field, None)
value = self._serialize_odoo_value(value)  # ‚Üê A√±adido
```

### 3. Debug Logging Temporal

**Archivo**: `models/res_partner.py`

A√±adido override temporal de `write()` con emoji ‚≠ê para distinguir de üîî del mixin:

```python
import logging

_logger = logging.getLogger(__name__)

class ResPartner(models.Model):
    _name = 'res.partner'
    _inherit = ['bidirectional.sync.mixin', 'res.partner']
    
    def write(self, vals):
        """Override para debug - verificar que se llama"""
        _logger.info(f"‚≠ê ResPartner.write() llamado con vals: {vals}")
        return super(ResPartner, self).write(vals)
```

**NOTA**: Este c√≥digo es TEMPORAL y debe eliminarse despu√©s de verificar en producci√≥n.

### 4. Verificaci√≥n Exitosa en Odoo18

**Test ejecutado**:
```bash
python3 test_bidirectional.py
```

**Resultado**:
```
‚úÖ Cliente encontrado: 2012 SACH SERVICE, S.L. (ID=5428)
   Cliente externo: 2012
   Contacto externo: SERV0000
   Tel√©fono actual: 666999999

‚úÖ BidirectionalSyncMixin est√° heredado correctamente

‚úÖ Configuraci√≥n de entidad encontrada:
   bidirectional: True
   pubsub_topic: sincronizacion-tablas
   nesto_table: Clientes

‚úÖ Variable de entorno GOOGLE_APPLICATION_CREDENTIALS configurada
   Ruta: /opt/odoo16/secrets/google-cloud-credentials.json
   ‚úÖ Archivo existe

üìù Actualizando tel√©fono a: 666642422

‚úÖ Actualizaci√≥n exitosa
   Tel√©fono nuevo: 666642422
```

**Logs obtenidos** (journalctl):
```
16:06:22,738 INFO odoo16 odoo.addons.nesto_sync.models.res_partner: ‚≠ê ResPartner.write() llamado con vals: {'mobile': '666642422'}
16:06:22,738 INFO odoo16 odoo.addons.nesto_sync.models.bidirectional_sync_mixin: üîî BidirectionalSyncMixin.write() llamado en res.partner con vals: {'mobile': '666642422'}
16:06:22,782 INFO odoo16 odoo.addons.nesto_sync.core.publisher_factory: Creando publisher para proveedor: google_pubsub
16:06:22,783 INFO odoo16 odoo.addons.nesto_sync.publishers.google_pubsub_publisher: Configurando Google Pub/Sub Publisher: project_id=nestomaps-1547636206945, topic_id=sincronizacion-tablas
16:06:22,785 INFO odoo16 odoo.addons.nesto_sync.core.odoo_publisher: Publicando cliente desde Odoo: res.partner ID 5428
```

‚úÖ **Confirmado**: Sincronizaci√≥n bidireccional funciona perfectamente

## üîç Descubrimiento Cr√≠tico: Dos Servidores

Al probar desde UI de Odoo, no aparec√≠an logs. Despu√©s de mucho debugging descubrimos:

### Servidor de Desarrollo (Odoo18)
- **Path**: `/opt/odoo16/custom_addons/nesto_sync`
- **Servicio**: `odoo16.service`
- **Estado**: ‚úÖ C√≥digo bidireccional implementado y funcionando
- **Logs**: `sudo journalctl -u odoo16`

### Servidor de Producci√≥n (nuevavisionodoo)
- **Path**: `/opt/odoo/custom_addons/nesto_sync`
- **Servicio**: `odoo.service` (o similar)
- **Estado**: ‚ùå C√≥digo antiguo, sin credenciales configuradas
- **Logs**: `sudo journalctl -u odoo`

**Conclusi√≥n**: Todos los cambios est√°n en Odoo18. El usuario estaba probando desde UI en nuevavisionodoo, por eso no ve√≠a los logs.

## üì¶ Commits Realizados

No se hicieron nuevos commits en esta sesi√≥n. Los commits de la sesi√≥n anterior siguen pendientes de push:

```
6720a7c: docs: A√±adir gu√≠a de configuraci√≥n segura de credenciales Google Cloud
400c7bd: security: Reforzar .gitignore para prevenir commit de credenciales
1692075: refactor: Eliminar flag from_nesto - anti-bucle basado solo en detecci√≥n de cambios
717a053: feat: Implementar sincronizaci√≥n bidireccional escalable (Odoo ‚Üí Nesto)
2ea371f: fix: A√±adir country_id din√°mico a parents y children usando CountryManager
```

**Cambios adicionales** (no commiteados):
- `core/odoo_publisher.py` - Fix serializaci√≥n JSON (l√≠neas 103-104, 221-259)
- `models/res_partner.py` - Debug logging temporal (l√≠neas 3, 5, 15-18)

## üìö Documentaci√≥n Creada

1. **PROXIMA_SESION.md**: Gu√≠a completa paso a paso para sincronizar c√≥digo a nuevavisionodoo
2. **ESTADO_DESPLIEGUE.md**: Actualizado con situaci√≥n de dos servidores
3. **SESION_2025-11-10.md**: Este documento

## üöß Problemas Encontrados y Soluciones

### Problema 1: DefaultCredentialsError en Python standalone

**Error**:
```
google.auth.exceptions.DefaultCredentialsError: Your default credentials were not found
```

**Causa**: Scripts Python standalone no heredan variables de entorno de systemd

**Soluci√≥n**: Las peticiones desde UI S√ç tienen las credenciales (via systemd). Los scripts standalone necesitan configurar la variable manualmente.

**Estado**: ‚úÖ Comportamiento esperado y normal

### Problema 2: JSON Serialization Error

**Error**:
```
TypeError: Object of type res.country.state is not JSON serializable
```

**Causa**: Many2one devuelve objetos Odoo completos

**Soluci√≥n**: M√©todo `_serialize_odoo_value()` que convierte objetos a IDs

**Estado**: ‚úÖ Arreglado en odoo_publisher.py

### Problema 3: Logs no aparec√≠an desde UI

**S√≠ntoma**: Al actualizar cliente desde UI, no aparec√≠an logs con emojis

**Causa**: Est√°bamos mirando logs de Odoo18, pero el usuario probaba en nuevavisionodoo

**Soluci√≥n**: Sincronizar c√≥digo de Odoo18 ‚Üí nuevavisionodoo

**Estado**: ‚è≥ Pendiente para pr√≥xima sesi√≥n

## üìã Tareas Pendientes para Pr√≥xima Sesi√≥n

Ver [PROXIMA_SESION.md](PROXIMA_SESION.md) para gu√≠a completa.

### 1. Sincronizar C√≥digo a nuevavisionodoo
- [ ] Git push desde Odoo18
- [ ] Git pull en nuevavisionodoo
- [ ] Verificar archivos actualizados

### 2. Configurar Credenciales en nuevavisionodoo
- [ ] Crear `/opt/odoo/secrets/` con permisos correctos
- [ ] Copiar google-cloud-credentials.json
- [ ] Editar servicio systemd
- [ ] A√±adir variable GOOGLE_APPLICATION_CREDENTIALS
- [ ] Configurar System Parameters

### 3. Actualizar M√≥dulo en nuevavisionodoo
- [ ] Limpiar cache Python (.pyc)
- [ ] Ejecutar `-u nesto_sync`
- [ ] Reiniciar servicio Odoo
- [ ] Verificar m√≥dulo cargado en logs

### 4. Validar desde UI en nuevavisionodoo
- [ ] Actualizar tel√©fono de cliente
- [ ] Verificar logs muestran üîî y ‚≠ê
- [ ] Confirmar publicaci√≥n a Pub/Sub
- [ ] Probar anti-bucle

### 5. Limpieza
- [ ] Eliminar c√≥digo debug temporal (‚≠ê) de res_partner.py
- [ ] Commit y push del fix de serializaci√≥n
- [ ] Actualizar ESTADO_DESPLIEGUE.md con verificaci√≥n

## üí° Aprendizajes

1. **Credenciales en systemd**: Las variables de entorno en systemd solo est√°n disponibles para procesos lanzados por systemd, no para scripts standalone.

2. **Serializaci√≥n de Odoo**: Los objetos Many2one necesitan `.id`, Many2many necesitan `.ids`. Un m√©todo recursivo es necesario para manejar estructuras anidadas.

3. **Debugging multi-servidor**: Usar emojis distintivos (‚≠ê vs üîî) ayuda a identificar qu√© c√≥digo se est√° ejecutando.

4. **Python cache**: Los archivos .pyc pueden causar que c√≥digo antiguo se ejecute. Siempre limpiar cache despu√©s de cambios.

5. **Verificaci√≥n de servidor**: Siempre verificar en qu√© servidor estamos trabajando con `pwd` y `hostname`.

## üìä Estad√≠sticas

- **Tiempo sesi√≥n**: ~2 horas
- **Bugs arreglados**: 1 (JSON serialization)
- **Archivos modificados**: 2 (odoo_publisher.py, res_partner.py)
- **Tests ejecutados**: 1 (test_bidirectional.py) ‚úÖ
- **Logs verificados**: ~50 l√≠neas
- **Documentaci√≥n creada**: 3 archivos

## üîó Referencias

- [CONFIGURACION_CREDENCIALES.md](CONFIGURACION_CREDENCIALES.md) - Gu√≠a de credenciales Google Cloud
- [PROXIMA_SESION.md](PROXIMA_SESION.md) - Pasos para siguiente sesi√≥n
- [ESTADO_DESPLIEGUE.md](ESTADO_DESPLIEGUE.md) - Estado actual del despliegue
- [test_bidirectional.py](test_bidirectional.py) - Script de prueba

---

**Creado**: 2025-11-10
**√öltima actualizaci√≥n**: 2025-11-10
**Estado**: Sesi√≥n completada, pendiente sincronizaci√≥n a producci√≥n
